#!/usr/bin/env php
<?php

include_once __DIR__ . '/../vendor/autoload.php';

use Buzz\Browser;
use Buzz\Client\Curl;
use Endurance\GarminConnect\GarminConnectClient;
use Endurance\Strava\StravaClient;

if (!is_file(__DIR__ . '/../config.json')) {
    echo "The config.json file was not found. Have you created a copy of config.json.default?\n";
    exit(1);
}

$config = json_decode(file_get_contents(__DIR__ . '/../config.json'), true);
if (!isset($config['lastActivity'])) {
    $config['lastActivity'] = 0;
}

try {
    if (isset($config['garmin'])) {
        $garminClient = new GarminConnectClient(new Browser(new Curl()));
        $garminClient->signIn($config['garmin']['username'], $config['garmin']['password']);
    }

    if (isset($config['strava'])) {
        $stravaClient = new StravaClient(new Browser(new Curl()));
        $stravaClient->signIn($config['strava']['email'], $config['strava']['password']);
    }
    
    $files = new RecursiveIteratorIterator(new RecursiveDirectoryIterator('/Volumes/GARMIN/Garmin/Activities', RecursiveDirectoryIterator::SKIP_DOTS));
    foreach ($files as $file) {
        if ($file->getMTime() > $config['lastActivity']) {
            if (isset($config['garmin'])) {
                echo sprintf('Uploading %s to Garmin Connect', $file->getFilename());
                try {
                    $result = $garminClient->uploadActivity($file->getPathname());
                    if (isset($result['detailedImportResult']['failures']) && count($result['detailedImportResult']['failures']) > 0) {
                        echo sprintf(' (Failed: "%s")', $result['detailedImportResult']['failures'][0]['messages'][0]['content']);
                    }
                } catch (\RuntimeException $exception) {
                    echo sprintf(' (Failed: "%s")', $exception->getMessage());
                }
                echo "\n";
            }

            if (isset($config['strava'])) {
                echo sprintf('Uploading %s to Strava', $file->getFilename());
                try {
                    $result = $stravaClient->uploadActivity($file->getPathname());
                    if (isset($result['upload_id'])) {
                        echo sprintf(' (ID: %s)', $result['upload_id']);
                    } else {
                        echo ' (Failed)';
                    }
                } catch (\RuntimeException $exception) {
                    echo sprintf(' (Failed: "%s")', $exception->getMessage());
                }

                echo "\n";
            }

            $config['lastActivity'] = $file->getMTime();
        }
    }

    file_put_contents(__DIR__ . '/../config.json', json_encode($config, JSON_FORCE_OBJECT));
} catch (RuntimeException $exception) {
    echo sprintf("Error: %s\n", $exception->getMessage());
    exit(1);
}
